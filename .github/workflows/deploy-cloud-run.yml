name: Deploy Cloud Run Functions

on:
  push:
    branches:
      - main
    paths:
      - '**'
  workflow_dispatch:

jobs:
  deploy-watch-query-function:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Watch Query Function (HTTP Trigger for Cloud Scheduler)
        run: |
          gcloud run deploy watch-query-function \
            --source=./watch-query-function \
            --region=us-central1 \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},GCP_PUB_SUB_GMAIL_WATCH_RENEWAL_TOPIC_ID=${{ secrets.GCP_PUB_SUB_GMAIL_WATCH_RENEWAL_TOPIC_ID }},DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --max-instances=10 \
            

  deploy-renewal-worker-function:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Debug - List files
        run: |
          pwd
          ls -la
          ls -la ./ || echo "Directory listing completed"

      - name: Deploy Renewal Worker Function (Pub/Sub Trigger)
        run: |
          gcloud run deploy renewal-worker-function \
            --source=./renewal-worker-function \
            --region=us-central1 \
            --platform=managed \
            --no-allow-unauthenticated \
            --set-env-vars="GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},DATABASE_URL=${{ secrets.DATABASE_URL }},GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --max-instances=10 \
            

      - name: Create Pub/Sub Trigger for Renewal Worker Function
        run: |
          # Create Pub/Sub subscription that triggers the Cloud Run service
          gcloud pubsub subscriptions create renewal-worker-subscription \
            --topic=${{ secrets.GCP_PUB_SUB_GMAIL_WATCH_RENEWAL_TOPIC_ID }} \
            --push-endpoint=https://renewal-worker-function-$(gcloud config get-value project | tr ':' '-' | tr '.' '-')-uc.a.run.app \
            --push-auth-service-account=dev-talentino-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --region=us-central1 || echo "Subscription already exists"


